name: singbox-ad

on:
  workflow_dispatch:
  schedule:
    # 每天 03:20 UTC（日本时间 12:20）
    - cron: "20 3 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl ca-certificates

      - name: Install sing-box (latest)
        run: |
          set -euo pipefail
          API="https://api.github.com/repos/SagerNet/sing-box/releases/latest"
          TAG="$(curl -fsSL "$API" | jq -r '.tag_name')"
          VER="${TAG#v}"
          TARBALL="sing-box-${VER}-linux-amd64.tar.gz"
          URL="https://github.com/SagerNet/sing-box/releases/download/${TAG}/${TARBALL}"

          echo "Downloading: $URL"
          curl -fsSL "$URL" -o /tmp/sing-box.tar.gz
          tar -xzf /tmp/sing-box.tar.gz -C /tmp
          sudo install -m 0755 "/tmp/sing-box-${VER}-linux-amd64/sing-box" /usr/local/bin/sing-box
          sing-box version

      - name: Run generator
        run: |
          chmod +x .github/scripts/singbox-ad.sh
          .github/scripts/singbox-ad.sh

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add compilation/ad/ad-singbox.json compilation/ad/ad-singbox.srs

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "Update sing-box ad ruleset"
          git push origin main
