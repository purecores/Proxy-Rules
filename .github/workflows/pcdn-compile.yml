name: pcdn-compile

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *" # 每天 UTC 03:17（按需改）

permissions:
  contents: write

concurrency:
  group: pcdn-ruleset-build
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Prepare dirs
        run: |
          set -euo pipefail
          mkdir -p compilation/pcdn
          mkdir -p .tmp/pcdn

      - name: Generate mihomo YAML & sing-box JSON from pcdn.list
        shell: bash
        run: |
          set -euo pipefail

          SRC_URL="https://raw.githubusercontent.com/uselibrary/PCDN/main/pcdn.list"
          SRC_FILE=".tmp/pcdn/pcdn.list"
          curl -fsSL "$SRC_URL" -o "$SRC_FILE"

          python3 - <<'PY'
          import json
          from pathlib import Path

          src = Path(".tmp/pcdn/pcdn.list").read_text(encoding="utf-8", errors="ignore")

          # pcdn.list 可能是一行，用空白切分后只保留形如 TYPE,value 的 token
          tokens = src.split()

          domains = []
          suffixes = []
          regexes = []

          def add_unique(lst, v):
            if v not in lst:
              lst.append(v)

          for t in tokens:
            # 忽略注释/中文说明等非规则 token
            if "," not in t:
              continue
            if t.startswith("#"):
              continue

            # 允许形如 "DOMAIN-SUFFIX,example.com"
            if t.startswith("DOMAIN-SUFFIX,"):
              val = t.split(",", 1)[1].strip()
              if val:
                add_unique(suffixes, val)
            elif t.startswith("DOMAIN,"):
              val = t.split(",", 1)[1].strip()
              if val:
                add_unique(domains, val)
            elif t.startswith("DOMAIN-REGEX,"):
              val = t.split(",", 1)[1].strip()
              if val:
                add_unique(regexes, val)

          # --- mihomo yaml (domain behavior source) ---
          # 采用 payload:
          #  - "+.example.com"   (suffix)
          #  - "a.example.com"  (full)
          # 注意：mihomo mrs（domain）不支持 regex，因此不写入 payload，仅做注释提示。
          mihomo_payload = []
          for s in suffixes:
            mihomo_payload.append(f"+.{s}")
          for d in domains:
            mihomo_payload.append(d)

          mihomo_lines = []
          mihomo_lines.append("# Generated from: https://raw.githubusercontent.com/uselibrary/PCDN/main/pcdn.list")
          mihomo_lines.append("# For mihomo .mrs: only DOMAIN / DOMAIN-SUFFIX are included (DOMAIN-REGEX is not supported in domain ruleset).")
          mihomo_lines.append(f"# Ignored DOMAIN-REGEX entries: {len(regexes)}")
          mihomo_lines.append("payload:")
          for item in mihomo_payload:
            # 简单转义：用双引号包裹，避免特殊字符影响 YAML
            mihomo_lines.append(f'  - "{item}"')

          Path(".tmp/pcdn/mihomo-pcdn.yaml").write_text("\n".join(mihomo_lines) + "\n", encoding="utf-8")

          # --- sing-box json (source ruleset) ---
          # 将 DOMAIN-SUFFIX -> domain_suffix，并加前导 "."，保持稳定语义
          sing = {
            "version": 4,
            "rules": [
              {
                "domain": domains,
                "domain_suffix": [f".{s}" for s in suffixes],
                "domain_regex": regexes,
              }
            ],
          }
          Path(".tmp/pcdn/singbox-pcdn.json").write_text(
            json.dumps(sing, ensure_ascii=False, indent=2) + "\n",
            encoding="utf-8",
          )

          print(f"domains={len(domains)} suffixes={len(suffixes)} regexes={len(regexes)}")
          PY

          # 覆盖更新目标源文件（不保留中间产物在仓库路径）
          mv -f .tmp/pcdn/mihomo-pcdn.yaml  compilation/pcdn/mihomo-pcdn.yaml
          mv -f .tmp/pcdn/singbox-pcdn.json compilation/pcdn/singbox-pcdn.json

      - name: Install sing-box (linux amd64)
        shell: bash
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/SagerNet/sing-box/releases/latest"
          url="$(curl -fsSL "$api" \
            | jq -r '.assets[].browser_download_url | select(test("sing-box-[0-9].*-linux-amd64\\.tar\\.gz$"))' \
            | head -n 1)"
          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "Failed to find sing-box linux-amd64 tar.gz asset from latest release."
            exit 1
          fi
          echo "Downloading: $url"
          curl -fsSL "$url" -o .tmp/pcdn/sing-box.tar.gz
          tar -xzf .tmp/pcdn/sing-box.tar.gz -C .tmp/pcdn
          # 通常解压后目录名形如 sing-box-1.xx.x-linux-amd64
          SB="$(find .tmp/pcdn -maxdepth 2 -type f -name sing-box | head -n 1)"
          if [ -z "$SB" ]; then
            echo "sing-box binary not found after extract."
            exit 1
          fi
          chmod +x "$SB"
          sudo mv "$SB" /usr/local/bin/sing-box
          sing-box version

      - name: Install mihomo (linux amd64 compatible)
        shell: bash
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"
          url="$(curl -fsSL "$api" \
            | jq -r '.assets[].browser_download_url | select(test("mihomo-linux-amd64-compatible-.*\\.gz$"))' \
            | head -n 1)"
          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "Failed to find mihomo linux-amd64-compatible .gz asset from latest release."
            exit 1
          fi
          echo "Downloading: $url"
          curl -fsSL "$url" -o .tmp/pcdn/mihomo.gz
          gzip -d -f .tmp/pcdn/mihomo.gz
          chmod +x .tmp/pcdn/mihomo
          sudo mv .tmp/pcdn/mihomo /usr/local/bin/mihomo
          mihomo -v || true

      - name: Compile to .mrs / .srs
        shell: bash
        run: |
          set -euo pipefail

          # mihomo: convert source yaml -> mrs (domain)
          mihomo convert-ruleset domain yaml \
            compilation/pcdn/mihomo-pcdn.yaml \
            compilation/pcdn/mihomo-pcdn.mrs

          # sing-box: compile source json -> srs
          sing-box rule-set compile \
            --output compilation/pcdn/singbox-pcdn.srs \
            compilation/pcdn/singbox-pcdn.json

          ls -lah compilation/pcdn

      - name: Commit & push (only final targets)
        shell: bash
        run: |
          set -euo pipefail

          git add \
            compilation/pcdn/mihomo-pcdn.yaml \
            compilation/pcdn/mihomo-pcdn.mrs \
            compilation/pcdn/singbox-pcdn.json \
            compilation/pcdn/singbox-pcdn.srs

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "chore: update PCDN rulesets"
          git push origin main
