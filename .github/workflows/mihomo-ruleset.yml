name: mihomo-ruleset

on:
  workflow_dispatch:
  schedule:
    # Runs at 06:40 CST (UTC+8)
    - cron: "45 22 * * *"
  push:
    branches: ["main"]
    paths:
      - "txt/mihomo/**"
      - "personaluse/personaluse-d.yaml"
      - "personaluse/personaluse-p.yaml"
      - ".github/scripts/mihomo-ruleset.sh"
      - ".github/workflows/mihomo-ruleset.yml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install dependencies (jq, yq, curl, gzip)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq curl ca-certificates gzip

          YQ_VERSION="v4.45.1"
          sudo curl -fsSL \
            "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" \
            -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version
          jq --version

      - name: Download mihomo (latest release, linux-amd64)
        run: |
          set -euo pipefail

          api="https://api.github.com/repos/MetaCubeX/mihomo/releases/latest"
          json="$(curl -fsSL "$api")"

          # Prefer tar.gz/tgz, fallback to gz
          url="$(echo "$json" | jq -r '
            [.assets[]
              | select(.name | test("linux.*amd64|amd64.*linux"; "i"))
              | select(.name | test("\\.tar\\.gz$|\\.tgz$|\\.gz$"; "i"))
              | {name: .name, url: .browser_download_url}
            ]
            | (map(select(.name | test("\\.tar\\.gz$|\\.tgz$"; "i"))) + map(select(.name | test("\\.gz$"; "i"))))
            | .[0].url
          ')"

          if [[ -z "$url" || "$url" == "null" ]]; then
            echo "ERROR: cannot find linux-amd64 asset url from latest release." >&2
            echo "$json" | jq -r '.assets[].name' >&2
            exit 1
          fi

          echo "Downloading: $url"
          mkdir -p mihomo_bin
          curl -fsSL --retry 3 --retry-delay 1 "$url" -o mihomo_bin/mihomo_asset

          if [[ "$url" =~ \.tar\.gz$ ]] || [[ "$url" =~ \.tgz$ ]]; then
            mv mihomo_bin/mihomo_asset mihomo_bin/mihomo.tar.gz
            tar -xzf mihomo_bin/mihomo.tar.gz -C mihomo_bin
          elif [[ "$url" =~ \.gz$ ]]; then
            mv mihomo_bin/mihomo_asset mihomo_bin/mihomo.gz
            gunzip -f mihomo_bin/mihomo.gz
          else
            mv mihomo_bin/mihomo_asset mihomo_bin/mihomo
          fi

          bin_path="$(find mihomo_bin -maxdepth 3 -type f -name 'mihomo' -print -quit || true)"
          if [[ -z "$bin_path" ]]; then
            echo "ERROR: mihomo binary not found after extracting." >&2
            find mihomo_bin -maxdepth 3 -type f -print >&2
            exit 1
          fi

          chmod +x "$bin_path"
          echo "MIHOMO_BIN=$bin_path" >> "$GITHUB_ENV"
          "$bin_path" -v || true

      - name: Merge & Compile
        run: |
          set -euo pipefail
          chmod +x .github/scripts/mihomo-ruleset.sh
          MIHOMO_BIN="${MIHOMO_BIN}" .github/scripts/mihomo-ruleset.sh

      - name: Commit outputs to repo
        id: commit
        if: github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          export TZ=Asia/Shanghai
          COMMIT_TIME="$(date '+%Y-%m-%d %H:%M:%S')"

          GIT_AUTHOR_DATE="$(date '+%Y-%m-%d %H:%M:%S %z')" \
          GIT_COMMITTER_DATE="$(date '+%Y-%m-%d %H:%M:%S %z')" \

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit both yaml and mrs (overwrite updates)
          git add compilation/mihomo/*.yaml compilation/mihomo/*.mrs || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "$COMMIT_TIME"
          echo "Changes detected and committed. Waiting for 45 seconds before pushing..."
          sleep 45s
          git push origin HEAD:${GITHUB_REF_NAME}
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Purge jsDelivr CDN cache
        if: steps.commit.outputs.changed == 'true'
        run: |
          set -e
          URL="https://purge.jsdelivr.net/gh/purecores/Proxy-Rules@main/compilation/mihomo/"
          echo "Purging: $URL"
          curl -s "$URL"
